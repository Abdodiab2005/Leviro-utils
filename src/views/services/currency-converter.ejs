<div class="max-w-2xl mx-auto">
  <div
    class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 md:p-12"
  >
    <div class="text-center mb-10">
      <div
        class="w-16 h-16 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6"
      >
        <i class="fa-solid fa-money-bill-transfer text-3xl"></i>
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-4">Currency Converter</h1>
      <p class="text-gray-600">
        Convert currencies with real-time exchange rates.
      </p>
    </div>

    <div class="space-y-6">
      <div>
        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2"
          >Amount</label
        >
        <input
          type="number"
          id="amount"
          value="1"
          min="0"
          step="any"
          class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
        />
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-[1fr,auto,1fr] gap-4 items-center relative"
      >
        <!-- From Currency -->
        <div class="relative" id="fromContainer">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >From</label
          >
          <button
            type="button"
            id="fromBtn"
            class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-left flex items-center justify-between focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
          >
            <span id="fromSelected" class="flex items-center gap-2">
              <span class="text-2xl">ðŸ‡ºðŸ‡¸</span>
              <span class="font-medium">USD</span>
              <span class="text-gray-500 text-sm truncate max-w-[100px]"
                >US Dollar</span
              >
            </span>
            <i class="fa-solid fa-chevron-down text-gray-400 text-sm"></i>
          </button>

          <!-- Dropdown -->
          <div
            id="fromDropdown"
            class="hidden absolute z-50 w-full mt-2 bg-white rounded-xl shadow-xl border border-gray-100 max-h-96 flex flex-col"
          >
            <div
              class="p-3 border-b border-gray-100 sticky top-0 bg-white rounded-t-xl"
            >
              <div class="relative">
                <i
                  class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                ></i>
                <input
                  type="text"
                  id="fromSearch"
                  placeholder="Search currency..."
                  class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-green-500 text-sm"
                />
              </div>
            </div>
            <div id="fromList" class="overflow-y-auto flex-1 p-1 space-y-1">
              <!-- Items populated by JS -->
            </div>
          </div>
        </div>

        <button
          id="swapBtn"
          class="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors md:mt-6 mx-auto z-10"
        >
          <i
            class="fa-solid fa-arrow-right-arrow-left transform rotate-90 md:rotate-0 text-lg"
          ></i>
        </button>

        <!-- To Currency -->
        <div class="relative" id="toContainer">
          <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
          <button
            type="button"
            id="toBtn"
            class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-left flex items-center justify-between focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
          >
            <span id="toSelected" class="flex items-center gap-2">
              <span class="text-2xl">ðŸ‡ªðŸ‡º</span>
              <span class="font-medium">EUR</span>
              <span class="text-gray-500 text-sm truncate max-w-[100px]"
                >Euro</span
              >
            </span>
            <i class="fa-solid fa-chevron-down text-gray-400 text-sm"></i>
          </button>

          <!-- Dropdown -->
          <div
            id="toDropdown"
            class="hidden absolute z-50 w-full mt-2 bg-white rounded-xl shadow-xl border border-gray-100 max-h-96 flex flex-col"
          >
            <div
              class="p-3 border-b border-gray-100 sticky top-0 bg-white rounded-t-xl"
            >
              <div class="relative">
                <i
                  class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                ></i>
                <input
                  type="text"
                  id="toSearch"
                  placeholder="Search currency..."
                  class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-green-500 text-sm"
                />
              </div>
            </div>
            <div id="toList" class="overflow-y-auto flex-1 p-1 space-y-1">
              <!-- Items populated by JS -->
            </div>
          </div>
        </div>
      </div>

      <div class="bg-green-50 p-6 rounded-xl text-center mt-8">
        <p class="text-sm text-green-600 font-medium mb-2">Converted Amount</p>
        <p id="result" class="text-4xl font-bold text-green-700">Loading...</p>
        <p id="rate" class="text-sm text-green-600 mt-2"></p>
      </div>
    </div>
  </div>
  <a
    href="https://www.exchangerate-api.com"
    target="_blank"
    class="text-sm text-green-600 mt-2 block text-center opacity-70 hover:opacity-100 transition-opacity"
    >Rates By Exchange Rate API</a
  >
</div>

<script>
  // State
  let currencies = [];
  let rates = {};
  let fromCurrency = { code: "USD", flag: "ðŸ‡ºðŸ‡¸", name: "US Dollar" };
  let toCurrency = { code: "EUR", flag: "ðŸ‡ªðŸ‡º", name: "Euro" };

  // Elements
  const els = {
    amount: document.getElementById("amount"),
    result: document.getElementById("result"),
    rate: document.getElementById("rate"),
    swap: document.getElementById("swapBtn"),
    from: {
      btn: document.getElementById("fromBtn"),
      selected: document.getElementById("fromSelected"),
      dropdown: document.getElementById("fromDropdown"),
      search: document.getElementById("fromSearch"),
      list: document.getElementById("fromList"),
      container: document.getElementById("fromContainer"),
    },
    to: {
      btn: document.getElementById("toBtn"),
      selected: document.getElementById("toSelected"),
      dropdown: document.getElementById("toDropdown"),
      search: document.getElementById("toSearch"),
      list: document.getElementById("toList"),
      container: document.getElementById("toContainer"),
    },
  };

  // Initialize
  async function init() {
    try {
      // Fetch data in parallel
      const [currenciesRes, ratesRes] = await Promise.all([
        fetch("/api/currencies"),
        fetch("https://open.er-api.com/v6/latest/USD"),
      ]);

      currencies = await currenciesRes.json();
      const ratesData = await ratesRes.json();
      rates = ratesData.rates;

      // Initial render
      renderList(els.from.list, "from");
      renderList(els.to.list, "to");
      calculate();
    } catch (err) {
      console.error("Initialization error:", err);
      els.result.textContent = "Error loading data";
    }
  }

  // Render Dropdown List
  function renderList(container, type, filter = "") {
    container.innerHTML = "";
    const search = filter.toLowerCase();

    const filtered = currencies.filter(
      (c) =>
        c.currency.toLowerCase().includes(search) ||
        c.currency_name.toLowerCase().includes(search) ||
        c.name.toLowerCase().includes(search) ||
        c.iso2.toLowerCase().includes(search) ||
        c.iso3.toLowerCase().includes(search)
    );

    // Use a Set to avoid duplicates based on currency code
    const seen = new Set();

    filtered.forEach((c) => {
      if (seen.has(c.currency)) return;
      seen.add(c.currency);

      const btn = document.createElement("button");
      btn.className =
        "w-full px-3 py-2 text-left hover:bg-gray-50 rounded-lg flex items-center gap-3 transition-colors";
      btn.innerHTML = `
                <span class="text-2xl">${c.emoji}</span>
                <div>
                    <div class="font-medium text-gray-900 flex items-center gap-2">
                        ${c.currency}
                        <span class="text-xs text-gray-400 font-normal">${c.iso3}</span>
                    </div>
                    <div class="text-xs text-gray-500">${c.currency_name}</div>
                </div>
            `;

      btn.onclick = () => selectCurrency(type, c);
      container.appendChild(btn);
    });

    if (filtered.length === 0) {
      container.innerHTML =
        '<div class="p-4 text-center text-gray-500 text-sm">No currencies found</div>';
    }
  }

  // Select Currency
  function selectCurrency(type, currency) {
    const data = {
      code: currency.currency,
      flag: currency.emoji,
      name: currency.currency_name,
    };

    if (type === "from") {
      fromCurrency = data;
      updateButton(els.from.selected, data);
      els.from.dropdown.classList.add("hidden");
    } else {
      toCurrency = data;
      updateButton(els.to.selected, data);
      els.to.dropdown.classList.add("hidden");
    }

    calculate();
  }

  function updateButton(el, data) {
    el.innerHTML = `
            <span class="text-2xl">${data.flag}</span>
            <span class="font-medium">${data.code}</span>
            <span class="text-gray-500 text-sm truncate max-w-[100px]">${data.name}</span>
        `;
  }

  // Calculation Logic
  function calculate() {
    const amount = parseFloat(els.amount.value) || 0;

    if (!rates[fromCurrency.code] || !rates[toCurrency.code]) {
      els.result.textContent = "Rate unavailable";
      return;
    }

    const rate = (1 / rates[fromCurrency.code]) * rates[toCurrency.code];
    const result = (amount * rate).toFixed(2);

    els.result.textContent = `${result} ${toCurrency.code}`;
    els.rate.textContent = `1 ${fromCurrency.code} = ${rate.toFixed(4)} ${
      toCurrency.code
    }`;
  }

  // Event Listeners
  els.amount.addEventListener("input", calculate);

  // Dropdown Toggles
  els.from.btn.addEventListener("click", (e) => {
    e.stopPropagation();
    closeAllDropdowns("from");
    els.from.dropdown.classList.toggle("hidden");
    if (!els.from.dropdown.classList.contains("hidden"))
      els.from.search.focus();
  });

  els.to.btn.addEventListener("click", (e) => {
    e.stopPropagation();
    closeAllDropdowns("to");
    els.to.dropdown.classList.toggle("hidden");
    if (!els.to.dropdown.classList.contains("hidden")) els.to.search.focus();
  });

  // Search
  els.from.search.addEventListener("input", (e) =>
    renderList(els.from.list, "from", e.target.value)
  );
  els.to.search.addEventListener("input", (e) =>
    renderList(els.to.list, "to", e.target.value)
  );

  // Swap
  els.swap.addEventListener("click", () => {
    const temp = { ...fromCurrency };
    fromCurrency = { ...toCurrency };
    toCurrency = temp;

    updateButton(els.from.selected, fromCurrency);
    updateButton(els.to.selected, toCurrency);
    calculate();
  });

  // Close dropdowns when clicking outside
  document.addEventListener("click", () => closeAllDropdowns());

  function closeAllDropdowns(except = null) {
    if (except !== "from") els.from.dropdown.classList.add("hidden");
    if (except !== "to") els.to.dropdown.classList.add("hidden");
  }

  // Prevent closing when clicking inside dropdown
  els.from.dropdown.addEventListener("click", (e) => e.stopPropagation());
  els.to.dropdown.addEventListener("click", (e) => e.stopPropagation());

  // Start
  init();
</script>
